<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Captura da Webcam</title>
  <style>
    :root {
      --bg: #0b1220; --card:#121a2b; --accent:#6ee7ff; --text:#e6edf6; --muted:#a4b1c7;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; background: radial-gradient(1200px 600px at 70% -10%, #173051 0%, var(--bg) 40%), var(--bg); color: var(--text); }
    .container { max-width: 960px; margin: 0 auto; padding: 32px 16px 48px; }
    .title { font-size: clamp(24px, 3vw, 36px); font-weight: 800; letter-spacing: 0.3px; margin: 8px 0 16px; }
    .subtitle { color: var(--muted); margin-bottom: 24px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .media { position: relative; aspect-ratio: 4/3; background: #0a0f1a; border: 1px dashed rgba(255,255,255,0.1); border-radius: 16px; overflow: hidden; display: grid; place-items: center; }
    video, canvas, img { width: 100%; height: 100%; object-fit: cover; }
    #previewImg { display: none; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 10px; }
    button, a.button { appearance: none; border: 1px solid rgba(255,255,255,0.12); background: #162236; color: var(--text); padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: transform .04s ease, background .2s ease, border-color .2s ease; text-decoration: none; }
    button:hover, a.button:hover { background: #1c2a45; border-color: rgba(110,231,255,0.4); }
    button:active, a.button:active { transform: translateY(1px); }
    .accent { border-color: rgba(110,231,255,0.6); background: linear-gradient(180deg, rgba(110,231,255,0.12), rgba(110,231,255,0.08)); }
    .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.14); color: var(--muted); font-size: 12px; display: inline-flex; align-items: center; gap: 8px; }
    .footer { color: var(--muted); font-size: 12px; margin-top: 18px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="pill">‚ö†Ô∏è Dica: este recurso requer HTTPS ou localhost</div>
    <h1 class="title">Capturar imagem da webcam</h1>
    <p class="subtitle">Clique em <strong>Iniciar c√¢mera</strong>, permita o acesso e depois <strong>Capturar</strong> para ver a foto na tela. Voc√™ pode baixar a imagem.</p>

    <div class="card">
      <div class="grid">
        <section>
          <div class="media" aria-live="polite" aria-label="Pr√©-visualiza√ß√£o da c√¢mera ou imagem capturada">
            <video id="video" playsinline autoplay muted></video>
            <canvas id="canvas" class="hidden"></canvas>
            <img id="previewImg" alt="Imagem capturada" />
          </div>
          <div class="controls">
            <button id="btnStart" class="accent">‚ñ∂Ô∏è Iniciar c√¢mera</button>
            <button id="btnCapture" disabled>üì∏ Capturar</button>
            <button id="btnRetake" class="hidden">‚Ü©Ô∏è Repetir</button>
            <button id="btnSwitch" title="Alternar c√¢mera (frontal/tra¬≠seira)">üîÑ Alternar c√¢mera</button>
            <a id="btnDownload" class="button hidden" download="captura-webcam.png">‚¨áÔ∏è Baixar</a>
            <button id="btnProcess" class="hidden">‚öôÔ∏è Processar</button>
          </div>
          <div id="status" class="footer" role="status" aria-live="polite"></div>
        </section>

        <aside>
          <h3>Como funciona</h3>
          <ol>
            <li>Clique em <em>Iniciar c√¢mera</em> e conceda permiss√£o.</li>
            <li>Use <em>Alternar c√¢mera</em> em celulares para trocar entre frontal e traseira.</li>
            <li>Clique em <em>Capturar</em> para tirar a foto.</li>
            <li>Use <em>Baixar</em> para salvar a imagem (PNG).</li>
          </ol>
          <p style="color: var(--muted); font-size: 14px; line-height: 1.5;">Observa√ß√µes: Em alguns iPhones/iPads, o Safari exige intera√ß√£o do usu√°rio para iniciar m√≠dia. Em ambientes sem HTTPS (exceto <code>localhost</code>), os navegadores podem bloquear o acesso √† c√¢mera.</p>
        </aside>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const previewImg = document.getElementById('previewImg');
    const btnStart = document.getElementById('btnStart');
    const btnCapture = document.getElementById('btnCapture');
    const btnRetake = document.getElementById('btnRetake');
    const btnSwitch = document.getElementById('btnSwitch');
    const btnDownload = document.getElementById('btnDownload');
    const statusEl = document.getElementById('status');

    let currentFacingMode = 'user';
    let currentStream = null;

    function setStatus(msg) { statusEl.textContent = msg || ''; }

    function stopStream() {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
    }

    async function startCamera() {
      stopStream();
      setStatus('Solicitando acesso √† c√¢mera‚Ä¶');
      const constraints = { video: { facingMode: { ideal: currentFacingMode }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        await video.play();
        btnCapture.disabled = false;
        btnRetake.classList.add('hidden');
        previewImg.classList.add('hidden');
        canvas.classList.add('hidden');
        video.classList.remove('hidden');
        setStatus('C√¢mera ativa.');
      } catch (err) {
        console.error(err);
        setStatus('N√£o foi poss√≠vel acessar a c√¢mera: ' + (err.message || err.name));
      }
    }

    btnStart.addEventListener('click', startCamera);

    btnSwitch.addEventListener('click', async () => {
      currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
      await startCamera();
    });

    btnCapture.addEventListener('click', () => {
      if (!currentStream) return;
      const track = currentStream.getVideoTracks()[0];
      const settings = track.getSettings?.() || {};
      const width = video.videoWidth || settings.width || 1280;
      const height = video.videoHeight || settings.height || 720;

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');

      // Espelha quando usando a c√¢mera frontal para parecer um espelho
      if (settings.facingMode === 'user' || currentFacingMode === 'user') {
        ctx.translate(width, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(video, 0, 0, width, height);

      const dataUrl = canvas.toDataURL('image/png');
      previewImg.src = dataUrl;

      // Alterna exibi√ß√£o
      video.classList.add('hidden');
      canvas.classList.add('hidden'); // mantemos canvas fora da tela
      previewImg.classList.remove('hidden');

      btnRetake.classList.remove('hidden');
      btnDownload.classList.remove('hidden');
      btnDownload.href = dataUrl;
      setStatus('Imagem capturada.');
    });

    btnRetake.addEventListener('click', () => {
      previewImg.classList.add('hidden');
      video.classList.remove('hidden');
      btnRetake.classList.add('hidden');
      btnDownload.classList.add('hidden');
      setStatus('Pronto para nova captura.');
    });
    const btnProcess = document.getElementById('btnProcess');

  btnProcess.addEventListener('click', async () => {
    if (!previewImg.src) return;
    try {
      const res = await fetch('http://127.0.0.1:5000/processar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: previewImg.src })
      });
      const msg = await res.text();
      alert("Servidor respondeu: " + msg);
    } catch (err) {
      console.error(err);
      alert("Erro ao enviar imagem para o servidor.");
    }
  });

  // quando capturar imagem, mostrar bot√£o processar
  btnCapture.addEventListener('click', () => {
    btnProcess.classList.remove('hidden');
  });
  btnRetake.addEventListener('click', () => {
    btnProcess.classList.add('hidden');
  });

    // Feche a c√¢mera ao sair da p√°gina
    window.addEventListener('beforeunload', stopStream);
  </script>
</body>
</html>
